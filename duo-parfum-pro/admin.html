<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel Admin — Duo Parfum</title>
  <link rel="stylesheet" href="./style.css">

  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="container row between center">
      <h2>Duo Parfum — Admin</h2>
      <nav class="row gap">
        <button id="btnLogout" class="btn ghost">Sair</button>
      </nav>
    </div>
  </header>

  <main class="container" style="margin-top:20px">
    <!-- Produtos -->
    <section>
      <h3>Produtos</h3>
      <form id="productForm" class="row wrap gap" style="margin-bottom:14px">
        <input id="pName" class="input" placeholder="Nome" required>
        <input id="pBrand" class="input" placeholder="Marca">
        <input id="pMl" class="input" placeholder="ML">
        <input id="pPrice" class="input" type="number" step="0.01" placeholder="Preço" required>
        <input id="pNotes" class="input" placeholder="Notas">
        <input id="pCategory" class="input" placeholder="Categoria">
        <input id="pImage" type="file" accept="image/*" class="input">
        <button class="btn">Salvar produto</button>
      </form>
      <div id="productList" class="grid"></div>
    </section>

    <hr style="margin:30px 0">

    <!-- Pedidos -->
    <section>
      <h3>Pedidos</h3>
      <div id="orderList" class="grid"></div>
    </section>
  </main>

  <script>
    const ADMIN_EMAILS = ["guilhermeserraglio03@gmail.com"];

    document.addEventListener("DOMContentLoaded", () => {
      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();

      const els = {
        form: document.getElementById("productForm"),
        pName: document.getElementById("pName"),
        pBrand: document.getElementById("pBrand"),
        pMl: document.getElementById("pMl"),
        pPrice: document.getElementById("pPrice"),
        pNotes: document.getElementById("pNotes"),
        pCategory: document.getElementById("pCategory"),
        pImage: document.getElementById("pImage"),
        productList: document.getElementById("productList"),
        orderList: document.getElementById("orderList"),
        btnLogout: document.getElementById("btnLogout")
      };

      /* ==== Proteção de acesso ==== */
      auth.onAuthStateChanged(user => {
        if (!user || !ADMIN_EMAILS.includes(user.email)) {
          alert("Acesso negado. Somente administradores.");
          window.location.href = "/";
        }
      });

      /* ==== Logout ==== */
      els.btnLogout.onclick = () => auth.signOut();

      /* ==== Produtos ==== */
      els.form.onsubmit = async (e) => {
        e.preventDefault();
        const file = els.pImage.files[0];
        let url = "";

        try {
          if (file) {
            const ref = storage.ref("products/" + Date.now() + "-" + file.name);
            await ref.put(file);
            url = await ref.getDownloadURL();
          }

          await db.collection("products").add({
            name: els.pName.value,
            brand: els.pBrand.value,
            ml: els.pMl.value,
            price: parseFloat(els.pPrice.value),
            notes: els.pNotes.value,
            category: els.pCategory.value,
            image: url,
            stock: 0,
            featured: false,
            createdAt: new Date()
          });

          els.form.reset();
          loadProducts();
        } catch (err) {
          console.error("Erro ao salvar produto:", err);
          alert("Erro ao salvar produto.");
        }
      };

      async function loadProducts() {
        const snap = await db.collection("products").orderBy("createdAt","desc").get();
        els.productList.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <img src="${d.image || "https://picsum.photos/200"}">
            <div class="pad">
              <div><strong>${d.name}</strong> (${d.ml || ""})</div>
              <div class="muted">${d.brand || ""}</div>
              <div class="muted">${(d.price||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</div>
              <div class="muted">Estoque: ${d.stock || 0}</div>
              <div class="row gap" style="margin-top:8px">
                <button class="btn small" onclick="updateStock('${doc.id}',1)">+1</button>
                <button class="btn small" onclick="updateStock('${doc.id}',-1)">-1</button>
                <button class="btn small" onclick="deleteProduct('${doc.id}')">Excluir</button>
              </div>
            </div>`;
          els.productList.appendChild(card);
        });
      }

      window.updateStock = async (id, delta) => {
        const ref = db.collection("products").doc(id);
        const snap = await ref.get();
        if (!snap.exists) return;
        const stock = (snap.data().stock || 0) + delta;
        await ref.update({ stock: Math.max(stock,0) });
        loadProducts();
      };

      window.deleteProduct = async (id) => {
        if (confirm("Excluir produto?")) {
          await db.collection("products").doc(id).delete();
          loadProducts();
        }
      };

      loadProducts();

      /* ==== Pedidos ==== */
      async function loadOrders() {
        const snap = await db.collection("orders").orderBy("createdAt","desc").get();
        els.orderList.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const card = document.createElement("div");
          card.className = "card";
          const items = d.items.map(i => `${i.qty}x ${i.name} ${i.ml||""}`).join("<br>");
          card.innerHTML = `
            <div class="pad">
              <div><strong>Cliente:</strong> ${d.customer?.name || ""}</div>
              <div><strong>Endereço:</strong> ${d.customer?.cep || ""}, ${d.customer?.address || ""}</div>
              <div><strong>Pagamento:</strong> ${d.customer?.payment || ""}</div>
              <div><strong>Itens:</strong><br>${items}</div>
              <div><strong>Total:</strong> ${(d.total||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</div>
              <div><strong>Status:</strong> ${d.status}</div>
              <div class="row gap" style="margin-top:8px">
                <button class="btn small" onclick="updateOrder('${doc.id}','paid')">Pago</button>
                <button class="btn small" onclick="updateOrder('${doc.id}','sent')">Enviado</button>
                <button class="btn small" onclick="updateOrder('${doc.id}','canceled')">Cancelado</button>
              </div>
            </div>`;
          els.orderList.appendChild(card);
        });
      }

      window.updateOrder = async (id, status) => {
        await db.collection("orders").doc(id).update({ status });
        loadOrders();
      };

      loadOrders();
    });
  </script>
</body>
</html>
