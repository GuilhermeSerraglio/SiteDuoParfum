<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Duo Parfum</title>
  <link rel="stylesheet" href="./style.css" />
  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>
  <script defer>
    const firebaseConfig = {
      apiKey: "AIzaSyDVkpsr4z6LolEOkNTGcc9TmKeiu4-mi1Y",
      authDomain: "duoparfum-61ec2.firebaseapp.com",
      projectId: "duoparfum-61ec2",
      storageBucket: "duoparfum-61ec2.firebasestorage.app",
      messagingSenderId: "889684986920",
      appId: "1:889684986920:web:9d452daf2192124b19391d"
    };
    const ADMIN_EMAILS = ["guilherme.serraglio03@gmail.com"];

    let app, db, auth, storage;
    let editingId = null;

    document.addEventListener("DOMContentLoaded", async ()=>{
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      storage = firebase.storage();

      const $ = id => document.getElementById(id);

      auth.onAuthStateChanged(async (user)=>{
        if(!user){ window.location.href = "./"; return; }
        if(!ADMIN_EMAILS.includes(user.email)){
          alert("Acesso negado.");
          window.location.href="./";
          return;
        }
        loadList();
      });

      $("btnLogin").onclick = async ()=>{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      };
      $("btnLogout").onclick = ()=> auth.signOut();

      $("btnCancel").onclick = ()=>{
        editingId = null;
        $("form").reset();
        $("submitLabel").textContent = "Salvar produto";
      };

      $("form").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const data = collectFormData();
        if(!data.name || !data.price){
          alert("Nome e preço são obrigatórios.");
          return;
        }

        const file = $("imageFile").files[0];
        try{
          $("submit").disabled = true;
          $("submitLabel").textContent = editingId ? "Atualizando…" : "Salvando…";

          if(editingId){
            if(file){
              data.image = await uploadImage(file, editingId);
            }
            data.updatedAt = new Date();
            await db.collection("products").doc(editingId).update(data);
            alert("Produto atualizado!");
          }else{
            const ref = await db.collection("products").add({
              ...data,
              createdAt: new Date()
            });
            if(file){
              const url = await uploadImage(file, ref.id);
              await ref.update({ image: url });
            }
            alert("Produto cadastrado!");
          }

          e.target.reset();
          editingId = null;
          $("submitLabel").textContent = "Salvar produto";
          loadList();
        }catch(err){
          console.error(err);
          alert("Erro: " + (err.message||err));
        }finally{
          $("submit").disabled = false;
        }
      });

      async function loadList(){
        const box = $("list");
        box.innerHTML = "<p class='muted'>Carregando…</p>";
        const snap = await db.collection("products").orderBy("createdAt","desc").get();
        box.innerHTML = "";
        snap.forEach(doc=>{
          const d = doc.data();
          const row = document.createElement("div");
          row.className = "card";
          row.innerHTML = `
            <div class="pad">
              <div class="row between wrap">
                <div>
                  <strong>${escapeHtml(d.name)}</strong> — ${escapeHtml(d.brand||"")} — R$ ${Number(d.price||0).toFixed(2)}
                  <div class="muted">${escapeHtml(d.category||"")} • ${escapeHtml(d.ml||"")} • estoque: ${d.stock??0}</div>
                </div>
                <img src="${sanitizeImg(d.image)}" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border)" alt="">
              </div>
              <div class="row gap" style="margin-top:10px">
                <button class="btn ghost" data-act="edit">Editar</button>
                <button class="btn ghost" data-act="del">Excluir</button>
              </div>
            </div>
          `;
          row.querySelector('[data-act="edit"]').onclick = ()=> startEdit(doc.id, d);
          row.querySelector('[data-act="del"]').onclick = async ()=>{
            if(confirm("Excluir este produto?")){
              await db.collection("products").doc(doc.id).delete();
              loadList();
            }
          };
          box.appendChild(row);
        });
      }

      function startEdit(id, d){
        editingId = id;
        $("name").value = d.name||"";
        $("brand").value = d.brand||"";
        $("price").value = d.price||"";
        $("ml").value = d.ml||"";
        $("category").value = d.category||"Decant";
        $("image").value = d.image||"";
        $("stock").value = d.stock??0;
        $("notes").value = d.notes||"";
        $("featured").checked = !!d.featured;
        $("submitLabel").textContent = "Atualizar produto";
        window.scrollTo({top:0,behavior:'smooth'});
      }

      function collectFormData(){
        return {
          name: $("name").value.trim(),
          brand: $("brand").value.trim(),
          price: parseFloat($("price").value||"0"),
          ml: $("ml").value.trim(),
          notes: $("notes").value.trim(),
          category: $("category").value,
          image: $("image").value.trim(),
          featured: $("featured").checked,
          stock: parseInt($("stock").value||"0",10)
        };
      }

      async function uploadImage(file, id){
        const safeName = (file.name||"img").replace(/[^a-z0-9_.-]/gi,'_').toLowerCase();
        const ref = storage.ref().child(`products/${id}/${Date.now()}_${safeName}`);
        const snap = await ref.put(file);
        return await snap.ref.getDownloadURL();
      }

      function sanitizeImg(src){ return src || "https://picsum.photos/seed/duoparfum/300/300"; }
      function escapeHtml(s=""){ return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    });
  </script>
</head>
<body>
  <header class="topbar">
    <div class="container row between center">
      <a class="brand-wrap" href="./">
        <img class="brand-logo" src="./assets/logo.jpg" alt="Duo Parfum logo"/>
        <span class="brand-name">Duo Parfum</span>
      </a>
      <div class="row">
        <button id="btnLogin" class="btn ghost">Entrar</button>
        <button id="btnLogout" class="btn ghost">Sair</button>
      </div>
    </div>
  </header>

  <main class="container" style="padding:20px 0">
    <h2>Adicionar / editar produto</h2>
    <form id="form" class="card" style="padding:16px;gap:10px">
      <div class="row wrap">
        <input id="name" required placeholder="Nome" style="flex:2;min-width:220px;padding:10px;border:1px solid var(--border);border-radius:10px">
        <input id="brand" placeholder="Marca" style="flex:1;min-width:160px;padding:10px;border:1px solid var(--border);border-radius:10px">
        <input id="price" required type="number" step="0.01" placeholder="Preço (R$)" style="width:160px;padding:10px;border:1px solid var(--border);border-radius:10px">
        <input id="ml" placeholder="Volume (ex: 10 ml)" style="width:160px;padding:10px;border:1px solid var(--border);border-radius:10px">
        <select id="category" style="width:180px;padding:10px;border:1px solid var(--border);border-radius:10px">
          <option>Decant</option><option>Importado</option><option>Nacional</option><option>Tester</option>
        </select>
        <input id="image" placeholder="URL da imagem (opcional)" style="flex:2;min-width:220px;padding:10px;border:1px solid var(--border);border-radius:10px">
        <input id="imageFile" type="file" accept="image/*" style="min-width:220px;padding:10px;border:1px solid var(--border);border-radius:10px">
        <input id="stock" type="number" placeholder="Estoque" style="width:120px;padding:10px;border:1px solid var(--border);border-radius:10px">
      </div>
      <textarea id="notes" rows="3" placeholder="Notas/descrição" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></textarea>
      <label style="display:flex;align-items:center;gap:8px">
        <input id="featured" type="checkbox"> Destacar no catálogo
      </label>
      <div class="row gap">
        <button id="submit" class="btn" type="submit"><span id="submitLabel">Salvar produto</span></button>
        <button id="btnCancel" class="btn ghost" type="button">Cancelar edição</button>
      </div>
    </form>

    <h2 style="margin-top:24px">Produtos</h2>
    <div id="list" class="grid"></div>
  </main>
</body>
</html>
