<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel Admin — Duo Parfum</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Poppins:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />

  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>
  <script defer src="./firebase-init.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="container row between center">
      <h2>Duo Parfum — Admin</h2>
      <nav class="row gap">
        <button id="btnLogout" class="btn ghost">Sair</button>
      </nav>
    </div>
  </header>

  <main class="container" style="margin-top:20px">
    <!-- Produtos -->
    <section>
      <h3>Produtos</h3>
      <form id="productForm" class="row wrap gap" style="margin-bottom:14px">
        <input id="pName" class="input" placeholder="Nome" required>
        <input id="pBrand" class="input" placeholder="Marca">
        <input id="pMl" class="input" placeholder="ML">
        <input id="pPrice" class="input" type="number" step="0.01" placeholder="Preço" required>
        <input id="pNotes" class="input" placeholder="Notas">
        <input id="pCategory" class="input" placeholder="Categoria">
        <input id="pImage" type="file" accept="image/*" class="input">
        <button class="btn">Salvar produto</button>
      </form>
      <div id="productList" class="grid"></div>
    </section>

    <hr style="margin:30px 0">

    <!-- Pedidos -->
    <section>
      <h3>Pedidos</h3>
      <div id="orderList" class="grid"></div>
    </section>
  </main>

  <script>
    const ADMIN_EMAILS = ["guilhermeserraglio03@gmail.com"];

    document.addEventListener("DOMContentLoaded", () => {
      const firebaseConfig = window.firebaseConfig || {
        apiKey: "AIzaSyDVkpsr4z6LolEOkNTGcc9TmKeiu4-mi1Y",
        authDomain: "duoparfum-61ec2.firebaseapp.com",
        projectId: "duoparfum-61ec2",
        storageBucket: "duoparfum-61ec2.firebasestorage.app",
        messagingSenderId: "889684986920",
        appId: "1:889684986920:web:9d452daf2192124b19391d"
      };

      if (!firebase.apps?.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();

      const els = {
        form: document.getElementById("productForm"),
        pName: document.getElementById("pName"),
        pBrand: document.getElementById("pBrand"),
        pMl: document.getElementById("pMl"),
        pPrice: document.getElementById("pPrice"),
        pNotes: document.getElementById("pNotes"),
        pCategory: document.getElementById("pCategory"),
        pImage: document.getElementById("pImage"),
        productList: document.getElementById("productList"),
        orderList: document.getElementById("orderList"),
        btnLogout: document.getElementById("btnLogout")
      };

      async function callProductsApi(method, payload = {}) {
        const user = auth.currentUser;
        if (!user) {
          const error = new Error("Usuário não autenticado");
          error.displayed = true;
          alert("Faça login novamente para continuar.");
          throw error;
        }

        let token;
        try {
          token = await user.getIdToken();
        } catch (err) {
          console.error("Erro ao obter token de autenticação:", err);
          const error = new Error("Falha ao obter token de autenticação");
          error.displayed = true;
          alert("Não foi possível confirmar sua autenticação. Faça login novamente.");
          throw error;
        }

        const options = {
          method,
          headers: {
            Authorization: `Bearer ${token}`
          }
        };

        if (method !== "GET" && method !== "HEAD") {
          options.headers["Content-Type"] = "application/json";
          options.body = JSON.stringify(payload || {});
        }

        try {
          const response = await fetch("/api/products", options);
          const text = await response.text();
          let data = null;

          if (text) {
            try {
              data = JSON.parse(text);
            } catch (err) {
              console.warn("Resposta da API de produtos não está em JSON válido:", err);
            }
          }

          if (!response.ok) {
            let message = (data && data.error) || "Erro ao processar a solicitação.";
            if (response.status === 401 || response.status === 403) {
              message = "Acesso negado. Somente administradores autorizados podem realizar esta ação.";
            }
            alert(message);
            const error = new Error(message);
            error.status = response.status;
            error.displayed = true;
            error.details = data;
            throw error;
          }

          return data;
        } catch (err) {
          if (!err?.displayed) {
            alert("Não foi possível comunicar com o servidor. Tente novamente.");
            err.displayed = true;
          }
          throw err;
        }
      }

      /* ==== Proteção de acesso ==== */
      auth.onAuthStateChanged(user => {
        if (!user || !ADMIN_EMAILS.includes(user.email)) {
          alert("Acesso negado. Somente administradores.");
          window.location.href = "/";
        }
      });

      /* ==== Logout ==== */
      els.btnLogout.onclick = () => auth.signOut();

      /* ==== Produtos ==== */
      els.form.onsubmit = async (e) => {
        e.preventDefault();
        const file = els.pImage.files[0];
        let url = "";
        const priceValue = parseFloat(els.pPrice.value);

        if (!Number.isFinite(priceValue)) {
          alert("Informe um preço válido.");
          return;
        }

        try {
          if (file) {
            const ref = storage.ref("products/" + Date.now() + "-" + file.name);
            await ref.put(file);
            url = await ref.getDownloadURL();
          }

          await callProductsApi("POST", {
            name: els.pName.value,
            brand: els.pBrand.value,
            ml: els.pMl.value,
            price: priceValue,
            notes: els.pNotes.value,
            category: els.pCategory.value,
            image: url,
            featured: false
          });

          els.form.reset();
          loadProducts();
        } catch (err) {
          console.error("Erro ao salvar produto:", err);
          if (!err?.displayed) {
            alert("Erro ao salvar produto.");
          }
        }
      };

      async function loadProducts() {
        const snap = await db.collection("products").orderBy("createdAt","desc").get();
        els.productList.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <img src="${d.image || "https://picsum.photos/200"}">
            <div class="pad">
              <div><strong>${d.name}</strong> (${d.ml || ""})</div>
              <div class="muted">${d.brand || ""}</div>
              <div class="muted">${(d.price||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</div>
              <div class="muted">Estoque: ${d.stock || 0}</div>
              <div class="row gap" style="margin-top:8px">
                <button class="btn small" onclick="updateStock('${doc.id}',1)">+1</button>
                <button class="btn small" onclick="updateStock('${doc.id}',-1)">-1</button>
                <button class="btn small" onclick="deleteProduct('${doc.id}')">Excluir</button>
              </div>
            </div>`;
          els.productList.appendChild(card);
        });
      }

      window.updateStock = async (id, delta) => {
        try {
          await callProductsApi("PATCH", { id, delta });
          loadProducts();
        } catch (err) {
          console.error("Erro ao atualizar estoque:", err);
          if (!err?.displayed) {
            alert("Erro ao atualizar estoque.");
          }
        }
      };

      window.deleteProduct = async (id) => {
        if (!confirm("Excluir produto?")) return;
        try {
          await callProductsApi("DELETE", { id });
          loadProducts();
        } catch (err) {
          console.error("Erro ao excluir produto:", err);
          if (!err?.displayed) {
            alert("Erro ao excluir produto.");
          }
        }
      };

      loadProducts();

      /* ==== Pedidos ==== */
      async function loadOrders() {
        const snap = await db.collection("orders").orderBy("createdAt","desc").get();
        els.orderList.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const card = document.createElement("div");
          card.className = "card";
          const items = d.items.map(i => `${i.qty}x ${i.name} ${i.ml||""}`).join("<br>");
          card.innerHTML = `
            <div class="pad">
              <div><strong>Cliente:</strong> ${d.customer?.name || ""}</div>
              <div><strong>E-mail:</strong> ${d.customer?.email || ""}</div>
              <div><strong>Endereço:</strong> ${d.customer?.cep || ""}, ${d.customer?.address || ""}</div>
              <div><strong>Pagamento:</strong> ${d.customer?.payment || ""}</div>
              <div><strong>Itens:</strong><br>${items}</div>
              <div><strong>Total:</strong> ${(d.total||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</div>
              <div><strong>Status:</strong> ${d.status}</div>
              <div class="row gap" style="margin-top:8px">
                <button class="btn small" onclick="updateOrder('${doc.id}','paid')">Pago</button>
                <button class="btn small" onclick="updateOrder('${doc.id}','sent')">Enviado</button>
                <button class="btn small" onclick="updateOrder('${doc.id}','canceled')">Cancelado</button>
              </div>
            </div>`;
          els.orderList.appendChild(card);
        });
      }

      window.updateOrder = async (id, status) => {
        await db.collection("orders").doc(id).update({ status });
        loadOrders();
      };

      loadOrders();
    });
  </script>
</body>
</html>
